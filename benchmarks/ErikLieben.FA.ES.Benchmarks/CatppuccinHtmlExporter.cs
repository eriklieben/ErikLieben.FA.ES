using BenchmarkDotNet.Exporters;
using BenchmarkDotNet.Loggers;
using BenchmarkDotNet.Reports;
using System.Text;
using System.Text.RegularExpressions;

namespace ErikLieben.FA.ES.Benchmarks;

/// <summary>
/// Custom HTML exporter with Catppuccin Mocha theme styling, metric explanations,
/// and grouped results with method descriptions.
/// </summary>
public class CatppuccinHtmlExporter : IExporter
{
    public static readonly CatppuccinHtmlExporter Default = new();

    public string Name => "catppuccin-html";

    public void ExportToLog(Summary summary, ILogger logger)
    {
        logger.WriteLine(BuildHtml(summary));
    }

    public IEnumerable<string> ExportToFiles(Summary summary, ILogger consoleLogger)
    {
        // Save results to cache for combining cold-start and warm data
        BenchmarkResultsCache.SaveResults(summary);

        var fileName = $"{summary.Title}-styled.html";
        var filePath = Path.Combine(summary.ResultsDirectoryPath, fileName);

        File.WriteAllText(filePath, BuildHtml(summary));

        return [filePath];
    }

    private static string BuildHtml(Summary summary)
    {
        var sb = new StringBuilder();

        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang=\"en\">");
        sb.AppendLine("<head>");
        sb.AppendLine("  <meta charset=\"UTF-8\">");
        sb.AppendLine("  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");
        sb.AppendLine($"  <title>{summary.Title} - Benchmark Results</title>");
        sb.AppendLine(GetStyles());
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");

        // Header
        sb.AppendLine("  <header>");
        sb.AppendLine($"    <h1>{FormatTitle(summary.Title)}</h1>");
        sb.AppendLine($"    <p class=\"subtitle\">Performance Benchmark Results</p>");
        sb.AppendLine("  </header>");

        sb.AppendLine("  <main>");

        // Summary card - what this benchmark tests
        AppendBenchmarkOverview(sb, summary);

        // Cold-start vs Warm performance explanation (for JSON benchmarks)
        AppendPerformanceCharacteristics(sb, summary);

        // Environment info card
        AppendEnvironmentCard(sb, summary);

        // Metrics explanation card (collapsible)
        AppendMetricsExplanation(sb);

        // Grouped results
        AppendGroupedResults(sb, summary);

        // Time unit legend
        AppendTimeUnitsLegend(sb);

        // Key takeaways
        AppendKeyTakeaways(sb, summary);

        // Runtime comparison (if multiple runtimes detected)
        AppendRuntimeComparison(sb, summary);

        sb.AppendLine("  </main>");

        // Footer
        sb.AppendLine("  <footer>");
        sb.AppendLine($"    <p>Generated by BenchmarkDotNet at {DateTime.Now:yyyy-MM-dd HH:mm:ss}</p>");
        sb.AppendLine("    <p>ErikLieben.FA.ES Event Sourcing Library</p>");
        sb.AppendLine("  </footer>");

        sb.AppendLine("</body>");
        sb.AppendLine("</html>");

        return sb.ToString();
    }

    private static string FormatTitle(string title)
    {
        // Convert "ErikLieben.FA.ES.Benchmarks.Serialization.JsonEventBenchmarks" to "JSON Event Benchmarks"
        var lastPart = title.Split('.').Last();
        // Insert spaces before capitals and remove "Benchmarks" suffix
        var formatted = Regex.Replace(lastPart, "(\\B[A-Z])", " $1");
        return formatted.Replace("Benchmarks", "").Trim();
    }

    private static void AppendBenchmarkOverview(StringBuilder sb, Summary summary)
    {
        sb.AppendLine("    <section class=\"card overview\">");
        sb.AppendLine("      <h2>&#128202; What This Benchmark Tests</h2>");

        // Extract class-level info based on benchmark type
        var title = summary.Title.ToLowerInvariant();

        if (title.Contains("serializationcomparison") || title.Contains("json"))
        {
            sb.AppendLine("      <div class=\"overview-content\">");
            sb.AppendLine("        <h3>Source-Generated vs Reflection-Based JSON Serialization</h3>");
            sb.AppendLine("        <p>This benchmark compares two JSON serialization approaches:</p>");
            sb.AppendLine("        <div class=\"comparison-info\">");
            sb.AppendLine("          <div class=\"comparison-item source-gen\">");
            sb.AppendLine("            <span class=\"comparison-title\">&#9889; Source-Generated (This Library)</span>");
            sb.AppendLine("            <ul>");
            sb.AppendLine("              <li><strong>How:</strong> Uses <code>System.Text.Json</code> with compile-time code generation</li>");
            sb.AppendLine("              <li><strong>Pros:</strong> Zero reflection, AOT-compatible, minimal allocations</li>");
            sb.AppendLine("              <li><strong>When:</strong> Every event append and read in production</li>");
            sb.AppendLine("            </ul>");
            sb.AppendLine("          </div>");
            sb.AppendLine("          <div class=\"comparison-item reflection\">");
            sb.AppendLine("            <span class=\"comparison-title\">&#128300; Reflection-Based (Traditional)</span>");
            sb.AppendLine("            <ul>");
            sb.AppendLine("              <li><strong>How:</strong> Uses <code>JsonSerializer</code> with runtime reflection</li>");
            sb.AppendLine("              <li><strong>Pros:</strong> Simpler setup, no code generation required</li>");
            sb.AppendLine("              <li><strong>Cons:</strong> Higher CPU/memory overhead, not AOT-compatible</li>");
            sb.AppendLine("            </ul>");
            sb.AppendLine("          </div>");
            sb.AppendLine("        </div>");
            sb.AppendLine("      </div>");

            // Add sample payloads section
            AppendSamplePayloads(sb);
        }
        else if (title.Contains("eventprocessing"))
        {
            sb.AppendLine("      <div class=\"overview-content\">");
            sb.AppendLine("        <h3>Event Processing Pipeline Overhead</h3>");
            sb.AppendLine("        <p>This benchmark measures the overhead of the event processing pipeline:</p>");
            sb.AppendLine("        <div class=\"comparison-info\">");
            sb.AppendLine("          <div class=\"comparison-item\">");
            sb.AppendLine("            <span class=\"comparison-title\">&#128229; Raw Deserialize</span>");
            sb.AppendLine("            <p>Pure JSON deserialization - just converting bytes to typed objects.</p>");
            sb.AppendLine("          </div>");
            sb.AppendLine("          <div class=\"comparison-item\">");
            sb.AppendLine("            <span class=\"comparison-title\">&#128230; ToEvent (with metadata)</span>");
            sb.AppendLine("            <p>Full event wrapper creation including metadata, version info, and IEvent interface.</p>");
            sb.AppendLine("          </div>");
            sb.AppendLine("        </div>");
            sb.AppendLine("        <p class=\"note\">The difference shows the overhead added by the event sourcing infrastructure.</p>");
            sb.AppendLine("      </div>");
        }
        else
        {
            sb.AppendLine("      <div class=\"overview-content\">");
            sb.AppendLine($"        <p>Performance benchmarks for <strong>{FormatTitle(summary.Title)}</strong>.</p>");
            sb.AppendLine("      </div>");
        }

        sb.AppendLine("    </section>");
    }

    private static void AppendSamplePayloads(StringBuilder sb)
    {
        sb.AppendLine("    <section class=\"card sample-payloads\">");
        sb.AppendLine("      <h2>&#128230; Sample Event Payloads</h2>");
        sb.AppendLine("      <p class=\"sample-intro\">These are the actual JSON payloads used in the benchmarks:</p>");

        sb.AppendLine("      <div class=\"payload-samples\">");

        // Small payload
        sb.AppendLine("        <div class=\"sample-item\">");
        sb.AppendLine("          <div class=\"sample-header\">");
        sb.AppendLine("            <span class=\"sample-size\">Small (~50 bytes)</span>");
        sb.AppendLine("            <span class=\"sample-name\">UserLoggedIn / ItemCreated</span>");
        sb.AppendLine("          </div>");
        sb.AppendLine("          <pre class=\"sample-code\"><code>{");
        sb.AppendLine("  \"id\": \"test-123\",");
        sb.AppendLine("  \"name\": \"Test Event\"");
        sb.AppendLine("}</code></pre>");
        sb.AppendLine("        </div>");

        // Medium payload
        sb.AppendLine("        <div class=\"sample-item\">");
        sb.AppendLine("          <div class=\"sample-header\">");
        sb.AppendLine("            <span class=\"sample-size\">Medium (~1 KB)</span>");
        sb.AppendLine("            <span class=\"sample-name\">OrderPlaced with line items</span>");
        sb.AppendLine("          </div>");
        sb.AppendLine("          <pre class=\"sample-code\"><code>{");
        sb.AppendLine("  \"id\": \"test-456\",");
        sb.AppendLine("  \"name\": \"Medium Test Event\",");
        sb.AppendLine("  \"description\": \"AAAA... (500 chars)\",");
        sb.AppendLine("  \"tags\": [\"tag-1\", \"tag-2\", ... \"tag-20\"],");
        sb.AppendLine("  \"properties\": {");
        sb.AppendLine("    \"key-1\": \"value-1\",");
        sb.AppendLine("    \"key-2\": \"value-2\",");
        sb.AppendLine("    ... (10 properties)");
        sb.AppendLine("  }");
        sb.AppendLine("}</code></pre>");
        sb.AppendLine("        </div>");

        // Large payload (if applicable)
        sb.AppendLine("        <div class=\"sample-item\">");
        sb.AppendLine("          <div class=\"sample-header\">");
        sb.AppendLine("            <span class=\"sample-size\">Large (~10 KB)</span>");
        sb.AppendLine("            <span class=\"sample-name\">BatchImport / DocumentSnapshot</span>");
        sb.AppendLine("          </div>");
        sb.AppendLine("          <pre class=\"sample-code\"><code>{");
        sb.AppendLine("  \"id\": \"test-789\",");
        sb.AppendLine("  \"name\": \"Large Test Event\",");
        sb.AppendLine("  \"description\": \"BBBB... (5000 chars)\",");
        sb.AppendLine("  \"tags\": [\"tag-1\", ... \"tag-100\"],");
        sb.AppendLine("  \"properties\": { ... 50 properties },");
        sb.AppendLine("  \"items\": [");
        sb.AppendLine("    { \"itemId\": 1, \"itemName\": \"Item 1\", \"itemValue\": 10.5 },");
        sb.AppendLine("    ... (50 nested items)");
        sb.AppendLine("  ]");
        sb.AppendLine("}</code></pre>");
        sb.AppendLine("        </div>");

        sb.AppendLine("      </div>");
        sb.AppendLine("    </section>");
    }

    private static void AppendPerformanceCharacteristics(StringBuilder sb, Summary summary)
    {
        var title = summary.Title.ToLowerInvariant();
        if (!title.Contains("serializationcomparison") && !title.Contains("json"))
            return;

        // Detect if this is a cold-start (Dry) or warm run
        var isColdStart = summary.Reports.Any(r =>
            r.BenchmarkCase.Job.Run.RunStrategy == BenchmarkDotNet.Engines.RunStrategy.ColdStart);

        sb.AppendLine("    <section class=\"card performance-characteristics\">");
        sb.AppendLine("      <h2>&#9200; Cold-Start vs Warm Performance</h2>");
        sb.AppendLine("      <p class=\"perf-intro\">Understanding when each performance characteristic matters:</p>");

        sb.AppendLine("      <div class=\"perf-comparison\">");

        // Cold-start section
        sb.AppendLine("        <div class=\"perf-scenario cold-start\">");
        sb.AppendLine("          <div class=\"scenario-header\">");
        sb.AppendLine("            <span class=\"scenario-icon\">&#10052;</span>");
        sb.AppendLine("            <span class=\"scenario-title\">Cold-Start (First Call)</span>");
        sb.AppendLine("          </div>");
        sb.AppendLine("          <div class=\"scenario-content\">");
        sb.AppendLine("            <div class=\"speedup-badge cold\">30-40x faster</div>");
        sb.AppendLine("            <p class=\"scenario-desc\">Source-Gen is <strong>dramatically faster</strong> on the first call because:</p>");
        sb.AppendLine("            <ul>");
        sb.AppendLine("              <li>No JIT compilation needed - code is pre-generated at build time</li>");
        sb.AppendLine("              <li>No reflection metadata inspection at runtime</li>");
        sb.AppendLine("              <li>No dynamic IL emission for serializers</li>");
        sb.AppendLine("            </ul>");
        sb.AppendLine("            <div class=\"when-matters\">");
        sb.AppendLine("              <strong>When this matters:</strong>");
        sb.AppendLine("              <ul>");
        sb.AppendLine("                <li>&#9889; Azure Functions / AWS Lambda (cold starts)</li>");
        sb.AppendLine("                <li>&#128187; Native AOT applications (no JIT available)</li>");
        sb.AppendLine("                <li>&#128640; Microservices with frequent restarts</li>");
        sb.AppendLine("                <li>&#128203; CLI tools (short-lived processes)</li>");
        sb.AppendLine("              </ul>");
        sb.AppendLine("            </div>");
        sb.AppendLine("          </div>");
        sb.AppendLine("        </div>");

        // Warm section
        sb.AppendLine("        <div class=\"perf-scenario warm\">");
        sb.AppendLine("          <div class=\"scenario-header\">");
        sb.AppendLine("            <span class=\"scenario-icon\">&#9728;</span>");
        sb.AppendLine("            <span class=\"scenario-title\">Warm (Steady-State)</span>");
        sb.AppendLine("          </div>");
        sb.AppendLine("          <div class=\"scenario-content\">");
        sb.AppendLine("            <div class=\"speedup-badge warm\">1.1-1.2x faster</div>");
        sb.AppendLine("            <p class=\"scenario-desc\">After the first call for each event type, Source-Gen is only <strong>slightly faster</strong> because:</p>");
        sb.AppendLine("            <ul>");
        sb.AppendLine("              <li>System.Text.Json caches reflection metadata <strong>per type</strong> after first use</li>");
        sb.AppendLine("              <li>JIT-compiled code is cached for subsequent calls of the same type</li>");
        sb.AppendLine("              <li>Processing 1000 events of the same type? Events 2-1000 run at nearly identical speed</li>");
        sb.AppendLine("            </ul>");
        sb.AppendLine("            <div class=\"when-matters\">");
        sb.AppendLine("              <strong>When this matters:</strong>");
        sb.AppendLine("              <ul>");
        sb.AppendLine("                <li>&#127760; Long-running web servers processing same event types</li>");
        sb.AppendLine("                <li>&#128296; Background services with predictable event schemas</li>");
        sb.AppendLine("                <li>&#128202; Batch processing 1000s of events (only first event per type is slow)</li>");
        sb.AppendLine("              </ul>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <p class=\"warm-note\"><strong>Key insight:</strong> If you process 1,000 OrderPlaced events, only the 1st one pays the cold-start cost. Events 2-1000 run at warm speed for both approaches.</p>");
        sb.AppendLine("          </div>");
        sb.AppendLine("        </div>");

        sb.AppendLine("      </div>");

        // Dynamic performance numbers from cache
        AppendDynamicPerformanceTable(sb, summary);

        // Current benchmark indicator
        if (isColdStart)
        {
            sb.AppendLine("      <div class=\"current-benchmark cold\">");
            sb.AppendLine("        <span class=\"indicator\">&#10052;</span>");
            sb.AppendLine("        <span>This benchmark shows <strong>cold-start</strong> performance (Job=Dry, RunStrategy=ColdStart)</span>");
            sb.AppendLine("      </div>");
        }
        else
        {
            sb.AppendLine("      <div class=\"current-benchmark warm\">");
            sb.AppendLine("        <span class=\"indicator\">&#9728;</span>");
            sb.AppendLine("        <span>This benchmark shows <strong>warm/steady-state</strong> performance (with proper warmup iterations)</span>");
            sb.AppendLine("      </div>");
        }

        sb.AppendLine("    </section>");
    }

    private static void AppendDynamicPerformanceTable(StringBuilder sb, Summary summary)
    {
        var comparisonData = BenchmarkResultsCache.GetComparisonData(summary.ResultsDirectoryPath);

        sb.AppendLine("      <div class=\"perf-numbers\">");

        if (comparisonData == null || comparisonData.Rows.Count == 0)
        {
            sb.AppendLine("        <p class=\"no-data-note\">Run both cold-start (<code>--job Dry</code>) and warm (<code>--config QuickBenchmarkConfig</code>) benchmarks to see comparison data here.</p>");
            sb.AppendLine("      </div>");
            return;
        }

        // Show data availability status
        var statusParts = new List<string>();
        if (comparisonData.HasColdStartData) statusParts.Add("Cold-Start");
        if (comparisonData.HasWarmData) statusParts.Add("Warm");
        var dataStatus = string.Join(" + ", statusParts);

        sb.AppendLine($"        <p class=\"data-source\">Data from actual benchmark runs ({dataStatus}). Last updated: {comparisonData.LastUpdated:yyyy-MM-dd HH:mm:ss} UTC</p>");

        // Time comparison table
        sb.AppendLine("        <h4>Measured Performance (Time)</h4>");
        sb.AppendLine("        <table class=\"perf-table\">");
        sb.AppendLine("          <thead>");
        sb.AppendLine("            <tr>");
        sb.AppendLine("              <th>Operation</th>");
        if (comparisonData.HasColdStartData)
        {
            sb.AppendLine("              <th colspan=\"2\" class=\"cold-header\">&#10052; Cold-Start (First Call)</th>");
        }
        if (comparisonData.HasWarmData)
        {
            sb.AppendLine("              <th colspan=\"2\" class=\"warm-header\">&#9728; Warm (Steady-State)</th>");
        }
        sb.AppendLine("            </tr>");
        sb.AppendLine("            <tr class=\"sub-header\">");
        sb.AppendLine("              <th></th>");
        if (comparisonData.HasColdStartData)
        {
            sb.AppendLine("              <th class=\"numeric\">Source-Gen</th>");
            sb.AppendLine("              <th class=\"numeric\">Reflection</th>");
        }
        if (comparisonData.HasWarmData)
        {
            sb.AppendLine("              <th class=\"numeric\">Source-Gen</th>");
            sb.AppendLine("              <th class=\"numeric\">Reflection</th>");
        }
        sb.AppendLine("            </tr>");
        sb.AppendLine("          </thead>");
        sb.AppendLine("          <tbody>");

        foreach (var row in comparisonData.Rows)
        {
            sb.AppendLine("            <tr>");
            sb.AppendLine($"              <td>{row.Operation}</td>");
            if (comparisonData.HasColdStartData)
            {
                sb.AppendLine($"              <td class=\"numeric source-gen\">{row.ColdStartSourceGen ?? "-"}</td>");
                sb.AppendLine($"              <td class=\"numeric reflection\">{row.ColdStartReflection ?? "-"}</td>");
            }
            if (comparisonData.HasWarmData)
            {
                sb.AppendLine($"              <td class=\"numeric source-gen\">{row.WarmSourceGen ?? "-"}</td>");
                sb.AppendLine($"              <td class=\"numeric reflection\">{row.WarmReflection ?? "-"}</td>");
            }
            sb.AppendLine("            </tr>");
        }

        sb.AppendLine("          </tbody>");
        sb.AppendLine("        </table>");

        // Memory allocation table (only for warm runs)
        if (comparisonData.HasWarmData)
        {
            sb.AppendLine("        <h4 style=\"margin-top: 1.5rem;\">Memory Allocation (Warm, per operation)</h4>");
            sb.AppendLine("        <table class=\"perf-table\">");
            sb.AppendLine("          <thead>");
            sb.AppendLine("            <tr>");
            sb.AppendLine("              <th>Operation</th>");
            sb.AppendLine("              <th class=\"numeric\">Source-Gen</th>");
            sb.AppendLine("              <th class=\"numeric\">Reflection</th>");
            sb.AppendLine("              <th class=\"numeric\">Difference</th>");
            sb.AppendLine("            </tr>");
            sb.AppendLine("          </thead>");
            sb.AppendLine("          <tbody>");

            foreach (var row in comparisonData.Rows)
            {
                var sourceGenBytes = row.WarmSourceGenBytes;
                var reflectionBytes = row.WarmReflectionBytes;

                string diff;
                if (sourceGenBytes == 0 && reflectionBytes == 0)
                    diff = "Zero alloc";
                else if (sourceGenBytes == reflectionBytes)
                    diff = "Same";
                else if (sourceGenBytes < reflectionBytes)
                {
                    var pct = (1.0 - (double)sourceGenBytes / reflectionBytes) * 100;
                    diff = $"<span class=\"source-gen\">{pct:F0}% less</span>";
                }
                else
                {
                    var pct = ((double)sourceGenBytes / reflectionBytes - 1.0) * 100;
                    diff = $"<span class=\"reflection\">{pct:F0}% more</span>";
                }

                sb.AppendLine("            <tr>");
                sb.AppendLine($"              <td>{row.Operation}</td>");
                sb.AppendLine($"              <td class=\"numeric source-gen\">{FormatBytesStatic(sourceGenBytes)}</td>");
                sb.AppendLine($"              <td class=\"numeric reflection\">{FormatBytesStatic(reflectionBytes)}</td>");
                sb.AppendLine($"              <td class=\"numeric\">{diff}</td>");
                sb.AppendLine("            </tr>");
            }

            sb.AppendLine("          </tbody>");
            sb.AppendLine("        </table>");
        }

        // Missing data hint
        if (!comparisonData.HasColdStartData || !comparisonData.HasWarmData)
        {
            sb.AppendLine("        <p class=\"perf-note\">");
            if (!comparisonData.HasColdStartData)
                sb.AppendLine("          <strong>Missing cold-start data:</strong> Run with <code>--job Dry</code> to measure first-call performance.<br/>");
            if (!comparisonData.HasWarmData)
                sb.AppendLine("          <strong>Missing warm data:</strong> Run with <code>--config QuickBenchmarkConfig</code> to measure steady-state performance.");
            sb.AppendLine("        </p>");
        }

        sb.AppendLine("        <p class=\"perf-note\"><strong>Note:</strong> us = microseconds (1/1,000,000 sec), ns = nanoseconds (1/1,000,000,000 sec), ms = milliseconds (1/1,000 sec). Cold-start times include JIT compilation overhead.</p>");
        sb.AppendLine("      </div>");
    }

    private static string FormatBytesStatic(long bytes)
    {
        if (bytes == 0) return "0 B";
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private static void AppendEnvironmentCard(StringBuilder sb, Summary summary)
    {
        var hostInfo = summary.HostEnvironmentInfo;

        // Safely get CPU info
        var cpuName = "";
        var cpuCores = "";
        try
        {
            var cpuInfo = hostInfo.CpuInfo.Value;
            if (cpuInfo != null)
            {
                // ProcessorName might be null or contain class name on Windows 11
                var processorName = cpuInfo.ProcessorName;

                // Validate it's a real CPU name (not a class name or empty)
                if (!string.IsNullOrEmpty(processorName) &&
                    !processorName.Contains("BenchmarkDotNet") &&
                    !processorName.Contains("CpuInfo"))
                {
                    cpuName = processorName;
                }

                // Build core count string if available
                var physicalCores = cpuInfo.PhysicalProcessorCount;
                var logicalCores = cpuInfo.LogicalCoreCount;
                if (physicalCores.HasValue && logicalCores.HasValue)
                {
                    cpuCores = $" ({physicalCores}C / {logicalCores}T)";
                }
                else if (logicalCores.HasValue)
                {
                    cpuCores = $" ({logicalCores} threads)";
                }
            }
        }
        catch { /* Ignore CPU info errors */ }

        // Build fallback CPU description if we couldn't get the name
        if (string.IsNullOrEmpty(cpuName))
        {
            var arch = hostInfo.Architecture ?? "X64";
            cpuName = $"{arch} Processor";
            if (!string.IsNullOrEmpty(cpuCores))
            {
                cpuName += cpuCores;
                cpuCores = ""; // Already included
            }
        }

        // Safely get OS info
        var osVersion = "Unknown";
        try
        {
            osVersion = hostInfo.OsVersion.Value ?? "Unknown";
        }
        catch { /* Ignore OS info errors */ }

        // Safely get hardware intrinsics info (AVX, etc)
        var hardwareIntrinsics = "";
        try
        {
            hardwareIntrinsics = hostInfo.HardwareIntrinsicsShort ?? "";
        }
        catch { /* Ignore hardware intrinsics errors */ }

        // Get .NET SDK version
        var sdkVersion = "Unknown";
        try
        {
            sdkVersion = hostInfo.DotNetSdkVersion.Value ?? "Unknown";
        }
        catch { /* Ignore SDK version errors */ }

        // Get runtime version
        var runtimeVersion = hostInfo.RuntimeVersion ?? "Unknown";

        // Get architecture info
        var architecture = hostInfo.Architecture ?? "Unknown";

        sb.AppendLine("    <section class=\"card\">");
        sb.AppendLine("      <h2>&#128187; Test Environment</h2>");
        sb.AppendLine("      <div class=\"env-grid\">");
        sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">OS</span><span class=\"value\">{osVersion}</span></div>");
        sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">CPU</span><span class=\"value\">{cpuName}{cpuCores}</span></div>");
        sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">Architecture</span><span class=\"value\">{architecture}</span></div>");
        if (!string.IsNullOrEmpty(hardwareIntrinsics))
        {
            sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">SIMD</span><span class=\"value\">{hardwareIntrinsics}</span></div>");
        }
        sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">.NET SDK</span><span class=\"value\">{sdkVersion}</span></div>");
        sb.AppendLine($"        <div class=\"env-item\"><span class=\"label\">Runtime</span><span class=\"value\">{runtimeVersion}</span></div>");
        sb.AppendLine("      </div>");
        sb.AppendLine("    </section>");
    }

    private static void AppendMetricsExplanation(StringBuilder sb)
    {
        sb.AppendLine("    <details class=\"card metrics-details\">");
        sb.AppendLine("      <summary><h2>Understanding the Metrics</h2></summary>");
        sb.AppendLine("      <div class=\"metrics-grid\">");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Mean</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Average execution time per operation. <strong>Lower is better.</strong></span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Error</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Half of the 99.9% confidence interval. Shows how precise the measurement is.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">StdDev</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Standard deviation. Lower means more consistent, predictable performance.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Ratio</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Performance relative to baseline (1.00). Values &lt;1 are faster than baseline.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Rank</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Position from fastest (#1) to slowest. Same rank = statistically equivalent.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Gen0 / Gen1</span>");
        sb.AppendLine("          <span class=\"metric-desc\">GC collections per 1,000 operations. Lower means less memory pressure.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"metric-item\">");
        sb.AppendLine("          <span class=\"metric-name\">Allocated</span>");
        sb.AppendLine("          <span class=\"metric-desc\">Heap memory allocated per operation. Lower reduces GC pauses.</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("      </div>");
        sb.AppendLine("    </details>");
    }

    private static void AppendGroupedResults(StringBuilder sb, Summary summary)
    {
        // Check if this is a comparison benchmark (has Source-Gen vs Reflection)
        var isComparisonBenchmark = summary.BenchmarksCases.Any(b =>
            b.Descriptor.WorkloadMethod.Name.Contains("SourceGen") ||
            b.Descriptor.WorkloadMethod.Name.Contains("Reflection"));

        if (isComparisonBenchmark)
        {
            AppendComparisonResults(sb, summary);
        }
        else
        {
            AppendStandardResults(sb, summary);
        }
    }

    private static void AppendComparisonResults(StringBuilder sb, Summary summary)
    {
        // Group by operation type and payload size for comparison view
        // E.g., "Serialize_Small" groups both SourceGen and Reflection variants
        var comparisonGroups = summary.BenchmarksCases
            .GroupBy(b => GetComparisonGroup(b.Descriptor.WorkloadMethod.Name))
            .OrderBy(g => GetComparisonOrder(g.Key));

        foreach (var group in comparisonGroups)
        {
            var (operation, payloadSize) = ParseComparisonGroup(group.Key);

            sb.AppendLine($"    <section class=\"card result-group comparison-group\">");
            sb.AppendLine($"      <h2>{GetComparisonIcon(operation)} {operation} - {payloadSize} Payload</h2>");
            sb.AppendLine($"      <p class=\"group-desc\">{GetComparisonDescription(operation, payloadSize)}</p>");

            sb.AppendLine("      <div class=\"table-container\">");
            sb.AppendLine("        <table class=\"comparison-table\">");

            // Header row
            var columns = summary.Table.Columns;
            sb.AppendLine("          <thead>");
            sb.AppendLine("            <tr>");
            sb.AppendLine("              <th>Approach</th>");

            foreach (var column in columns)
            {
                if (!column.NeedToShow) continue;
                if (column.Header == "Method" || column.Header == "Categories") continue;
                var alignClass = IsNumericColumn(column.Header) ? "numeric" : "";
                sb.AppendLine($"              <th class=\"{alignClass}\">{column.Header}</th>");
            }
            sb.AppendLine("            </tr>");
            sb.AppendLine("          </thead>");

            sb.AppendLine("          <tbody>");

            // Order: Source-Gen first (baseline), then Reflection
            var orderedBenchmarks = group.OrderBy(b =>
                b.Descriptor.WorkloadMethod.Name.Contains("Reflection") ? 1 : 0);

            foreach (var benchmark in orderedBenchmarks)
            {
                var report = summary.Reports.FirstOrDefault(r => r.BenchmarkCase == benchmark);
                if (report == null) continue;

                var rowIndex = summary.BenchmarksCases.IndexOf(benchmark);
                if (rowIndex < 0 || rowIndex >= summary.Table.FullContent.Length) continue;

                var row = summary.Table.FullContent[rowIndex];
                var isSourceGen = benchmark.Descriptor.WorkloadMethod.Name.Contains("SourceGen");
                var rowClass = isSourceGen ? "baseline-row source-gen-row" : "reflection-row";

                // Use the Description attribute or format nicely
                var approach = benchmark.Descriptor.WorkloadMethodDisplayInfo;
                if (string.IsNullOrEmpty(approach) || approach == benchmark.Descriptor.WorkloadMethod.Name)
                {
                    approach = isSourceGen ? "Source-Generated" : "Reflection-Based";
                }

                var icon = isSourceGen ? "&#9889;" : "&#128300;"; // âš¡ vs ðŸ”¬

                sb.AppendLine($"            <tr class=\"{rowClass}\">");
                sb.AppendLine($"              <td class=\"approach-cell\">{icon} {approach}</td>");

                for (int i = 0; i < row.Length; i++)
                {
                    if (!columns[i].NeedToShow) continue;
                    if (columns[i].Header == "Method" || columns[i].Header == "Categories") continue;
                    var alignClass = IsNumericColumn(columns[i].Header) ? "numeric" : "";
                    var cellClass = GetCellClass(columns[i].Header, row[i]);
                    sb.AppendLine($"              <td class=\"{alignClass} {cellClass}\">{row[i]}</td>");
                }
                sb.AppendLine("            </tr>");
            }
            sb.AppendLine("          </tbody>");

            sb.AppendLine("        </table>");
            sb.AppendLine("      </div>");

            // Add comparison insight for this group
            AppendComparisonInsight(sb, summary, group);

            sb.AppendLine("    </section>");
        }
    }

    private static void AppendComparisonInsight(StringBuilder sb, Summary summary, IGrouping<string, BenchmarkDotNet.Running.BenchmarkCase> group)
    {
        var sourceGen = group.FirstOrDefault(b => b.Descriptor.WorkloadMethod.Name.Contains("SourceGen"));
        var reflection = group.FirstOrDefault(b => b.Descriptor.WorkloadMethod.Name.Contains("Reflection"));

        if (sourceGen == null || reflection == null) return;

        var sourceGenReport = summary.Reports.FirstOrDefault(r => r.BenchmarkCase == sourceGen);
        var reflectionReport = summary.Reports.FirstOrDefault(r => r.BenchmarkCase == reflection);

        if (sourceGenReport?.ResultStatistics == null || reflectionReport?.ResultStatistics == null) return;

        var speedup = reflectionReport.ResultStatistics.Mean / sourceGenReport.ResultStatistics.Mean;
        var sourceGenAlloc = sourceGenReport.GcStats.GetBytesAllocatedPerOperation(sourceGen) ?? 0;
        var reflectionAlloc = reflectionReport.GcStats.GetBytesAllocatedPerOperation(reflection) ?? 0;

        sb.AppendLine("      <div class=\"comparison-insight\">");
        sb.AppendLine($"        <span class=\"insight-badge\">{speedup:F1}x faster</span>");
        sb.AppendLine($"        <span class=\"insight-text\">Source-generated serialization is <strong>{speedup:F1}x faster</strong> than reflection-based");

        if (sourceGenAlloc > 0 && reflectionAlloc > 0)
        {
            var allocRatio = (double)reflectionAlloc / sourceGenAlloc;
            if (allocRatio > 1.1)
            {
                sb.AppendLine($" and allocates <strong>{allocRatio:F1}x less memory</strong>");
            }
        }
        sb.AppendLine(".</span>");
        sb.AppendLine("      </div>");
    }

    private static void AppendStandardResults(StringBuilder sb, Summary summary)
    {
        // Original grouping logic for non-comparison benchmarks
        var benchmarksByGroup = summary.BenchmarksCases
            .GroupBy(b => GetOperationGroup(b.Descriptor.WorkloadMethod.Name))
            .OrderBy(g => GetGroupOrder(g.Key));

        foreach (var group in benchmarksByGroup)
        {
            sb.AppendLine($"    <section class=\"card result-group\">");
            sb.AppendLine($"      <h2>{GetGroupIcon(group.Key)} {group.Key}</h2>");
            sb.AppendLine($"      <p class=\"group-desc\">{GetGroupDescription(group.Key)}</p>");

            sb.AppendLine("      <div class=\"table-container\">");
            sb.AppendLine("        <table>");

            var columns = summary.Table.Columns;
            sb.AppendLine("          <thead>");
            sb.AppendLine("            <tr>");
            sb.AppendLine("              <th>Description</th>");

            foreach (var column in columns)
            {
                if (!column.NeedToShow) continue;
                if (column.Header == "Method") continue;
                var alignClass = IsNumericColumn(column.Header) ? "numeric" : "";
                sb.AppendLine($"              <th class=\"{alignClass}\">{column.Header}</th>");
            }
            sb.AppendLine("            </tr>");
            sb.AppendLine("          </thead>");

            sb.AppendLine("          <tbody>");

            foreach (var benchmark in group.OrderBy(b => GetPayloadOrder(b.Descriptor.WorkloadMethod.Name)))
            {
                var report = summary.Reports.FirstOrDefault(r => r.BenchmarkCase == benchmark);
                if (report == null) continue;

                var rowIndex = summary.BenchmarksCases.IndexOf(benchmark);
                if (rowIndex < 0 || rowIndex >= summary.Table.FullContent.Length) continue;

                var row = summary.Table.FullContent[rowIndex];
                var isBaseline = benchmark.Descriptor.Baseline;
                var rowClass = isBaseline ? "baseline-row" : "";

                var description = benchmark.Descriptor.WorkloadMethodDisplayInfo;
                if (string.IsNullOrEmpty(description) || description == benchmark.Descriptor.WorkloadMethod.Name)
                {
                    description = FormatMethodName(benchmark.Descriptor.WorkloadMethod.Name);
                }

                sb.AppendLine($"            <tr class=\"{rowClass}\">");
                sb.AppendLine($"              <td class=\"description-cell\">{description}</td>");

                for (int i = 0; i < row.Length; i++)
                {
                    if (!columns[i].NeedToShow) continue;
                    if (columns[i].Header == "Method") continue;
                    var alignClass = IsNumericColumn(columns[i].Header) ? "numeric" : "";
                    var cellClass = GetCellClass(columns[i].Header, row[i]);
                    sb.AppendLine($"              <td class=\"{alignClass} {cellClass}\">{row[i]}</td>");
                }
                sb.AppendLine("            </tr>");
            }
            sb.AppendLine("          </tbody>");

            sb.AppendLine("        </table>");
            sb.AppendLine("      </div>");
            sb.AppendLine("    </section>");
        }
    }

    private static string GetComparisonGroup(string methodName)
    {
        // Extract "Serialize_Small" from "Serialize_Small_SourceGen" or "Serialize_Small_Reflection"
        var parts = methodName.Split('_');
        if (parts.Length >= 2)
        {
            return $"{parts[0]}_{parts[1]}";
        }
        return methodName;
    }

    private static int GetComparisonOrder(string groupKey)
    {
        // Order: Serialize Small, Serialize Medium, Deserialize Small, Deserialize Medium
        return groupKey switch
        {
            "Serialize_Small" => 1,
            "Serialize_Medium" => 2,
            "Deserialize_Small" => 3,
            "Deserialize_Medium" => 4,
            "Small_RawDeserialize" or "Small_ToEvent" => 5,
            "Medium_RawDeserialize" or "Medium_ToEvent" => 6,
            "Large_RawDeserialize" or "Large_ToEvent" => 7,
            _ when groupKey.Contains("Small") => 10,
            _ when groupKey.Contains("Medium") => 11,
            _ when groupKey.Contains("Large") => 12,
            _ => 99
        };
    }

    private static (string operation, string payloadSize) ParseComparisonGroup(string groupKey)
    {
        var parts = groupKey.Split('_');
        if (parts.Length >= 2)
        {
            var operation = parts[0] switch
            {
                "Serialize" => "Serialization",
                "Deserialize" => "Deserialization",
                _ => parts[0]
            };
            return (operation, parts[1]);
        }
        return (groupKey, "");
    }

    private static string GetComparisonIcon(string operation)
    {
        return operation switch
        {
            "Serialization" => "&#128221;",    // ðŸ“
            "Deserialization" => "&#128214;",  // ðŸ“–
            _ => "&#128202;"                    // ðŸ“Š
        };
    }

    private static string GetComparisonDescription(string operation, string payloadSize)
    {
        var payloadDesc = payloadSize switch
        {
            "Small" => "~100 bytes - simple events like UserLoggedIn",
            "Medium" => "~1KB - events with collections like OrderPlaced",
            "Large" => "~10KB - complex events like document snapshots",
            _ => payloadSize
        };

        return operation switch
        {
            "Serialization" => $"Converting typed event objects to JSON. Payload: {payloadDesc}",
            "Deserialization" => $"Converting JSON back to typed objects. Payload: {payloadDesc}",
            _ => $"Testing {operation.ToLower()} with {payloadSize.ToLower()} payloads ({payloadDesc})"
        };
    }

    private static string GetOperationGroup(string methodName)
    {
        if (methodName.StartsWith("Serialize")) return "Serialization (Write Path)";
        if (methodName.StartsWith("Deserialize")) return "Deserialization (Read Path)";
        if (methodName.StartsWith("ToEvent")) return "Event Conversion (Fold Path)";
        if (methodName.Contains("Append")) return "Append Operations";
        if (methodName.Contains("Read")) return "Read Operations";
        if (methodName.Contains("Fold")) return "Folding Operations";
        return "Other Operations";
    }

    private static int GetGroupOrder(string groupName)
    {
        return groupName switch
        {
            "Serialization (Write Path)" => 1,
            "Deserialization (Read Path)" => 2,
            "Event Conversion (Fold Path)" => 3,
            _ => 99
        };
    }

    private static string GetGroupIcon(string groupName)
    {
        return groupName switch
        {
            "Serialization (Write Path)" => "&#x1F4DD;",      // ðŸ“
            "Deserialization (Read Path)" => "&#x1F4D6;",     // ðŸ“–
            "Event Conversion (Fold Path)" => "&#x1F504;",    // ðŸ”„
            "Append Operations" => "&#x2795;",                 // âž•
            "Read Operations" => "&#x1F4E5;",                  // ðŸ“¥
            "Folding Operations" => "&#x1F9E9;",              // ðŸ§©
            _ => "&#x1F4CA;"                                   // ðŸ“Š
        };
    }

    private static string GetGroupDescription(string groupName)
    {
        return groupName switch
        {
            "Serialization (Write Path)" => "Converting typed event objects to JSON strings when appending events to streams.",
            "Deserialization (Read Path)" => "Converting stored JSON strings back to typed event objects when reading from streams.",
            "Event Conversion (Fold Path)" => "Full event conversion including metadata wrapping, used during aggregate rehydration.",
            "Append Operations" => "Writing events to the event stream storage.",
            "Read Operations" => "Reading events from the event stream storage.",
            "Folding Operations" => "Applying events to aggregate state.",
            _ => "Performance measurements for various operations."
        };
    }

    private static int GetPayloadOrder(string methodName)
    {
        if (methodName.Contains("Small")) return 1;
        if (methodName.Contains("Medium")) return 2;
        if (methodName.Contains("Large")) return 3;
        return 99;
    }

    private static string FormatMethodName(string methodName)
    {
        // Convert "DeserializeSmallPayload" to "Small payload (~100B)"
        var formatted = Regex.Replace(methodName, "(\\B[A-Z])", " $1").ToLower();

        if (methodName.Contains("Small")) return "Small payload (~100 bytes)";
        if (methodName.Contains("Medium")) return "Medium payload (~1 KB)";
        if (methodName.Contains("Large")) return "Large payload (~10 KB)";

        return formatted;
    }

    private static void AppendTimeUnitsLegend(StringBuilder sb)
    {
        sb.AppendLine("    <section class=\"card legend\">");
        sb.AppendLine("      <h2>Time Units Reference</h2>");
        sb.AppendLine("      <div class=\"units-grid\">");
        sb.AppendLine("        <div class=\"unit\"><span class=\"unit-name\">ns</span><span class=\"unit-desc\">nanoseconds (1 billionth of a second)</span></div>");
        sb.AppendLine("        <div class=\"unit\"><span class=\"unit-name\">Î¼s</span><span class=\"unit-desc\">microseconds (1 millionth of a second)</span></div>");
        sb.AppendLine("        <div class=\"unit\"><span class=\"unit-name\">ms</span><span class=\"unit-desc\">milliseconds (1 thousandth of a second)</span></div>");
        sb.AppendLine("        <div class=\"unit\"><span class=\"unit-name\">B</span><span class=\"unit-desc\">bytes of memory allocated per operation</span></div>");
        sb.AppendLine("        <div class=\"unit\"><span class=\"unit-name\">KB</span><span class=\"unit-desc\">kilobytes (1,024 bytes)</span></div>");
        sb.AppendLine("      </div>");
        sb.AppendLine("    </section>");
    }

    private static void AppendKeyTakeaways(StringBuilder sb, Summary summary)
    {
        sb.AppendLine("    <section class=\"card takeaways\">");
        sb.AppendLine("      <h2>&#x1F4A1; Key Insights</h2>");
        sb.AppendLine("      <ul class=\"insights-list\">");

        // Find fastest and slowest
        var reports = summary.Reports.Where(r => r.ResultStatistics != null).ToList();
        if (reports.Any())
        {
            var fastest = reports.OrderBy(r => r.ResultStatistics!.Mean).First();
            var slowest = reports.OrderByDescending(r => r.ResultStatistics!.Mean).First();

            var fastestName = fastest.BenchmarkCase.Descriptor.WorkloadMethod.Name;
            var slowestName = slowest.BenchmarkCase.Descriptor.WorkloadMethod.Name;
            var ratio = slowest.ResultStatistics!.Mean / fastest.ResultStatistics!.Mean;

            sb.AppendLine($"        <li><strong>Fastest operation:</strong> {FormatMethodName(fastestName)} at {FormatTime(fastest.ResultStatistics!.Mean)}</li>");
            sb.AppendLine($"        <li><strong>Slowest operation:</strong> {FormatMethodName(slowestName)} at {FormatTime(slowest.ResultStatistics!.Mean)} ({ratio:F0}x slower)</li>");

            // Check for memory allocation patterns
            var maxAlloc = reports.Max(r => (r.GcStats.GetBytesAllocatedPerOperation(r.BenchmarkCase) ?? 0));
            var minAlloc = reports.Min(r => (r.GcStats.GetBytesAllocatedPerOperation(r.BenchmarkCase) ?? 0));

            if (maxAlloc > 0)
            {
                sb.AppendLine($"        <li><strong>Memory allocation:</strong> ranges from {FormatBytes(minAlloc)} to {FormatBytes(maxAlloc)} per operation</li>");
            }

            // Scaling insight
            if (summary.Title.ToLowerInvariant().Contains("json"))
            {
                sb.AppendLine("        <li><strong>Scaling:</strong> Performance scales roughly linearly with payload size due to efficient source-generated JSON serialization</li>");
            }

            // Source-Gen vs Reflection comparison insight
            var sourceGenReports = reports.Where(r => r.BenchmarkCase.Descriptor.WorkloadMethod.Name.Contains("SourceGen")).ToList();
            var reflectionReports = reports.Where(r => r.BenchmarkCase.Descriptor.WorkloadMethod.Name.Contains("Reflection")).ToList();

            if (sourceGenReports.Any() && reflectionReports.Any())
            {
                var avgSourceGen = sourceGenReports.Average(r => r.ResultStatistics!.Mean);
                var avgReflection = reflectionReports.Average(r => r.ResultStatistics!.Mean);
                var avgSpeedup = avgReflection / avgSourceGen;

                sb.AppendLine($"        <li><strong>Source-Gen advantage:</strong> On average <strong>{avgSpeedup:F1}x faster</strong> than reflection-based serialization</li>");
            }
        }

        sb.AppendLine("      </ul>");
        sb.AppendLine("    </section>");
    }

    private static void AppendRuntimeComparison(StringBuilder sb, Summary summary)
    {
        // Check if we have multiple runtimes in the benchmark results
        // This happens when using [SimpleJob(RuntimeMoniker.Net90)] and [SimpleJob(RuntimeMoniker.Net100)]
        // or when the benchmark is run via BenchmarkSwitcher with multiple TFMs

        // Look for Job column that contains runtime info
        var jobColumn = summary.Table.Columns.FirstOrDefault(c => c.Header == "Job" || c.Header == "Runtime");
        if (jobColumn == null || !jobColumn.NeedToShow)
        {
            // No multi-runtime comparison in this run, add a note about how to compare
            AppendRuntimeComparisonNote(sb, summary);
            return;
        }

        // Group benchmarks by method name to compare across runtimes
        var runtimeGroups = new Dictionary<string, List<(string Runtime, BenchmarkDotNet.Reports.BenchmarkReport Report)>>();

        foreach (var report in summary.Reports)
        {
            if (report.ResultStatistics == null) continue;

            var methodName = report.BenchmarkCase.Descriptor.WorkloadMethod.Name;
            var rowIndex = summary.BenchmarksCases.IndexOf(report.BenchmarkCase);
            if (rowIndex < 0) continue;

            var jobColumnIndex = Array.IndexOf(summary.Table.Columns.Select(c => c.Header).ToArray(), jobColumn.Header);
            if (jobColumnIndex < 0) continue;

            var runtime = summary.Table.FullContent[rowIndex][jobColumnIndex];

            if (!runtimeGroups.ContainsKey(methodName))
                runtimeGroups[methodName] = new List<(string, BenchmarkDotNet.Reports.BenchmarkReport)>();

            runtimeGroups[methodName].Add((runtime, report));
        }

        // Only show if we have multiple runtimes for at least one method
        var methodsWithMultipleRuntimes = runtimeGroups.Where(g => g.Value.Count > 1).ToList();
        if (!methodsWithMultipleRuntimes.Any())
        {
            AppendRuntimeComparisonNote(sb, summary);
            return;
        }

        sb.AppendLine("    <section class=\"card runtime-comparison\">");
        sb.AppendLine("      <h2>&#128640; Runtime Comparison</h2>");
        sb.AppendLine("      <p class=\"group-desc\">Performance comparison across different .NET runtimes</p>");

        sb.AppendLine("      <div class=\"table-container\">");
        sb.AppendLine("        <table>");
        sb.AppendLine("          <thead>");
        sb.AppendLine("            <tr>");
        sb.AppendLine("              <th>Method</th>");
        sb.AppendLine("              <th>Runtime</th>");
        sb.AppendLine("              <th class=\"numeric\">Mean</th>");
        sb.AppendLine("              <th class=\"numeric\">Allocated</th>");
        sb.AppendLine("              <th class=\"numeric\">Difference</th>");
        sb.AppendLine("            </tr>");
        sb.AppendLine("          </thead>");
        sb.AppendLine("          <tbody>");

        foreach (var group in methodsWithMultipleRuntimes.OrderBy(g => g.Key))
        {
            var orderedRuntimes = group.Value.OrderBy(r => r.Runtime).ToList();
            var baseline = orderedRuntimes.First();

            foreach (var (runtime, report) in orderedRuntimes)
            {
                var isBaseline = report == baseline.Report;
                var rowClass = runtime.Contains("10") ? "net10-row" : (runtime.Contains("9") ? "net9-row" : "");

                var mean = report.ResultStatistics!.Mean;
                var allocated = report.GcStats.GetBytesAllocatedPerOperation(report.BenchmarkCase) ?? 0;

                string diffText = "";
                if (!isBaseline)
                {
                    var baselineMean = baseline.Report.ResultStatistics!.Mean;
                    var ratio = mean / baselineMean;
                    if (ratio < 0.95)
                        diffText = $"<span class=\"faster\">{(1 - ratio) * 100:F1}% faster</span>";
                    else if (ratio > 1.05)
                        diffText = $"<span class=\"slower\">{(ratio - 1) * 100:F1}% slower</span>";
                    else
                        diffText = "<span class=\"same\">~same</span>";
                }

                sb.AppendLine($"            <tr class=\"{rowClass}\">");
                sb.AppendLine($"              <td>{FormatMethodName(group.Key)}</td>");
                sb.AppendLine($"              <td><span class=\"runtime-badge {(runtime.Contains("10") ? "net10" : "net9")}\">{runtime}</span></td>");
                sb.AppendLine($"              <td class=\"numeric\">{FormatTime(mean)}</td>");
                sb.AppendLine($"              <td class=\"numeric\">{FormatBytes(allocated)}</td>");
                sb.AppendLine($"              <td class=\"numeric\">{diffText}</td>");
                sb.AppendLine("            </tr>");
            }
        }

        sb.AppendLine("          </tbody>");
        sb.AppendLine("        </table>");
        sb.AppendLine("      </div>");

        // Summary stats
        var fasterOnNet10 = 0;
        var fasterOnNet9 = 0;
        var similar = 0;

        foreach (var group in methodsWithMultipleRuntimes)
        {
            var net9Report = group.Value.FirstOrDefault(r => r.Runtime.Contains("9")).Report;
            var net10Report = group.Value.FirstOrDefault(r => r.Runtime.Contains("10")).Report;

            if (net9Report?.ResultStatistics != null && net10Report?.ResultStatistics != null)
            {
                var ratio = net10Report.ResultStatistics.Mean / net9Report.ResultStatistics.Mean;
                if (ratio < 0.95) fasterOnNet10++;
                else if (ratio > 1.05) fasterOnNet9++;
                else similar++;
            }
        }

        sb.AppendLine("      <div class=\"runtime-summary\">");
        sb.AppendLine("        <div class=\"runtime-stat\">");
        sb.AppendLine($"          <span class=\"stat-value faster\">{fasterOnNet10}</span>");
        sb.AppendLine("          <span class=\"stat-label\">faster on .NET 10</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"runtime-stat\">");
        sb.AppendLine($"          <span class=\"stat-value\">{similar}</span>");
        sb.AppendLine("          <span class=\"stat-label\">similar performance</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class=\"runtime-stat\">");
        sb.AppendLine($"          <span class=\"stat-value slower\">{fasterOnNet9}</span>");
        sb.AppendLine("          <span class=\"stat-label\">faster on .NET 9</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("      </div>");

        sb.AppendLine("    </section>");
    }

    private static void AppendRuntimeComparisonNote(StringBuilder sb, Summary summary)
    {
        // Show current runtime info and how to compare across runtimes
        var runtimeVersion = summary.HostEnvironmentInfo.RuntimeVersion ?? "Unknown";

        sb.AppendLine("    <section class=\"card runtime-note\">");
        sb.AppendLine("      <h2>&#128640; Runtime Information</h2>");
        sb.AppendLine($"      <p>This benchmark was run on <strong>{runtimeVersion}</strong>.</p>");
        sb.AppendLine("      <p class=\"note\">To compare .NET 9 vs .NET 10 performance, run the benchmarks on each runtime separately:</p>");
        sb.AppendLine("      <pre class=\"command-example\"><code>dotnet run -c Release -f net9.0 -- --filter *JsonSerializationComparison*</code></pre>");
        sb.AppendLine("      <pre class=\"command-example\"><code>dotnet run -c Release -f net10.0 -- --filter *JsonSerializationComparison*</code></pre>");
        sb.AppendLine("      <p class=\"note\">Or use the <code>Compare-Runtimes.ps1</code> script to automatically run both and generate a combined comparison report.</p>");
        sb.AppendLine("    </section>");
    }

    private static string FormatTime(double nanoseconds)
    {
        return nanoseconds switch
        {
            < 1000 => $"{nanoseconds:F1} ns",
            < 1000000 => $"{nanoseconds / 1000:F2} Î¼s",
            _ => $"{nanoseconds / 1000000:F2} ms"
        };
    }

    private static string FormatBytes(long bytes)
    {
        return bytes switch
        {
            < 1024 => $"{bytes} B",
            < 1024 * 1024 => $"{bytes / 1024.0:F1} KB",
            _ => $"{bytes / (1024.0 * 1024.0):F1} MB"
        };
    }

    private static bool IsNumericColumn(string header)
    {
        return header is "Mean" or "Error" or "StdDev" or "Median" or "P95"
            or "Ratio" or "RatioSD" or "Rank" or "Gen0" or "Gen1" or "Gen2"
            or "Allocated" or "Alloc Ratio";
    }

    private static string GetCellClass(string header, string value)
    {
        if (header == "Rank")
        {
            return value switch
            {
                "1" => "rank-first",
                "2" => "rank-second",
                "3" => "rank-third",
                _ => ""
            };
        }

        if (header == "Ratio" && double.TryParse(value, out var ratio))
        {
            return ratio switch
            {
                < 0.5 => "ratio-excellent",
                < 1.0 => "ratio-good",
                1.0 => "ratio-baseline",
                < 2.0 => "ratio-slower",
                _ => "ratio-much-slower"
            };
        }

        return "";
    }

    private static string GetStyles() => """
    <style>
      /* Catppuccin Mocha color palette */
      :root {
        --ctp-rosewater: #f5e0dc;
        --ctp-flamingo: #f2cdcd;
        --ctp-pink: #f5c2e7;
        --ctp-mauve: #cba6f7;
        --ctp-red: #f38ba8;
        --ctp-maroon: #eba0ac;
        --ctp-peach: #fab387;
        --ctp-yellow: #f9e2af;
        --ctp-green: #a6e3a1;
        --ctp-teal: #94e2d5;
        --ctp-sky: #89dceb;
        --ctp-sapphire: #74c7ec;
        --ctp-blue: #89b4fa;
        --ctp-lavender: #b4befe;
        --ctp-text: #cdd6f4;
        --ctp-subtext1: #bac2de;
        --ctp-subtext0: #a6adc8;
        --ctp-overlay2: #9399b2;
        --ctp-overlay1: #7f849c;
        --ctp-overlay0: #6c7086;
        --ctp-surface2: #585b70;
        --ctp-surface1: #45475a;
        --ctp-surface0: #313244;
        --ctp-base: #1e1e2e;
        --ctp-mantle: #181825;
        --ctp-crust: #11111b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: var(--ctp-base);
        color: var(--ctp-text);
        line-height: 1.6;
        min-height: 100vh;
      }

      header {
        background: linear-gradient(135deg, var(--ctp-surface0), var(--ctp-mantle));
        padding: 2.5rem 2rem;
        text-align: center;
        border-bottom: 2px solid var(--ctp-mauve);
      }

      header h1 {
        font-size: 2.25rem;
        color: var(--ctp-lavender);
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      header .subtitle {
        color: var(--ctp-subtext0);
        font-size: 1.1rem;
      }

      main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--ctp-surface0);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--ctp-surface1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .card h2 {
        color: var(--ctp-mauve);
        font-size: 1.25rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--ctp-surface1);
        font-weight: 600;
      }

      /* Overview card */
      .overview {
        background: linear-gradient(135deg, var(--ctp-surface0), rgba(203, 166, 247, 0.1));
        border-left: 4px solid var(--ctp-mauve);
      }

      .overview-content h3 {
        color: var(--ctp-lavender);
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
      }

      .overview-content h4 {
        color: var(--ctp-subtext0);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .overview-content p {
        color: var(--ctp-text);
        margin-bottom: 1rem;
        font-size: 1.05rem;
      }

      .overview-content .note {
        color: var(--ctp-subtext0);
        font-style: italic;
        margin-top: 1rem;
        padding: 0.75rem;
        background: var(--ctp-surface1);
        border-radius: 6px;
        border-left: 3px solid var(--ctp-yellow);
      }

      /* Comparison info boxes */
      .comparison-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
      }

      .comparison-item {
        background: var(--ctp-surface1);
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid var(--ctp-overlay1);
      }

      .comparison-item.source-gen {
        border-left-color: var(--ctp-green);
        background: linear-gradient(135deg, var(--ctp-surface1), rgba(166, 227, 161, 0.05));
      }

      .comparison-item.reflection {
        border-left-color: var(--ctp-blue);
        background: linear-gradient(135deg, var(--ctp-surface1), rgba(137, 180, 250, 0.05));
      }

      .comparison-title {
        display: block;
        color: var(--ctp-text);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .comparison-item ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .comparison-item li {
        color: var(--ctp-subtext1);
        font-size: 0.9rem;
        padding: 0.25rem 0;
      }

      .comparison-item li strong {
        color: var(--ctp-subtext0);
      }

      .comparison-item p {
        color: var(--ctp-subtext1);
        font-size: 0.9rem;
        margin: 0;
      }

      .payload-legend {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--ctp-surface1);
      }

      .payload-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .payload-item {
        background: var(--ctp-surface1);
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .payload-size {
        color: var(--ctp-peach);
        font-weight: 600;
        font-family: 'Cascadia Code', 'Fira Code', monospace;
      }

      .payload-desc {
        color: var(--ctp-subtext1);
        font-size: 0.9rem;
      }

      .payload-desc code {
        background: var(--ctp-surface2);
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        color: var(--ctp-teal);
      }

      /* Comparison group styling */
      .comparison-group {
        border-left: 4px solid var(--ctp-sapphire);
      }

      .comparison-table {
        margin-bottom: 0;
      }

      .source-gen-row {
        background: rgba(166, 227, 161, 0.1);
      }

      .source-gen-row:hover {
        background: rgba(166, 227, 161, 0.15);
      }

      .reflection-row {
        background: rgba(137, 180, 250, 0.05);
      }

      .reflection-row:hover {
        background: rgba(137, 180, 250, 0.1);
      }

      .approach-cell {
        font-family: 'Segoe UI', system-ui, sans-serif;
        font-weight: 500;
        min-width: 180px;
      }

      .comparison-insight {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, rgba(166, 227, 161, 0.1), rgba(166, 227, 161, 0.05));
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid rgba(166, 227, 161, 0.2);
      }

      .insight-badge {
        background: var(--ctp-green);
        color: var(--ctp-crust);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .insight-text {
        color: var(--ctp-text);
        font-size: 0.95rem;
      }

      .insight-text strong {
        color: var(--ctp-green);
      }

      /* Performance characteristics section */
      .performance-characteristics {
        border-left: 4px solid var(--ctp-peach);
        background: linear-gradient(135deg, var(--ctp-surface0), rgba(250, 179, 135, 0.05));
      }

      .perf-intro {
        color: var(--ctp-subtext0);
        margin-bottom: 1rem;
      }

      .perf-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .perf-scenario {
        background: var(--ctp-surface1);
        border-radius: 12px;
        overflow: hidden;
      }

      .perf-scenario.cold-start {
        border: 2px solid var(--ctp-blue);
      }

      .perf-scenario.warm {
        border: 2px solid var(--ctp-green);
      }

      .scenario-header {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .cold-start .scenario-header {
        background: rgba(137, 180, 250, 0.2);
        color: var(--ctp-blue);
      }

      .warm .scenario-header {
        background: rgba(166, 227, 161, 0.2);
        color: var(--ctp-green);
      }

      .scenario-icon {
        font-size: 1.5rem;
      }

      .scenario-content {
        padding: 1rem;
      }

      .speedup-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
      }

      .speedup-badge.cold {
        background: var(--ctp-blue);
        color: var(--ctp-crust);
      }

      .speedup-badge.warm {
        background: var(--ctp-green);
        color: var(--ctp-crust);
      }

      .scenario-desc {
        color: var(--ctp-text);
        margin-bottom: 0.75rem;
      }

      .scenario-content ul {
        list-style: none;
        padding: 0;
        margin: 0 0 1rem 0;
      }

      .scenario-content li {
        color: var(--ctp-subtext1);
        padding: 0.25rem 0 0.25rem 1.25rem;
        position: relative;
      }

      .scenario-content li::before {
        content: 'â€¢';
        position: absolute;
        left: 0;
        color: var(--ctp-overlay1);
      }

      .when-matters {
        background: var(--ctp-surface2);
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 0.75rem;
      }

      .when-matters strong {
        color: var(--ctp-text);
        display: block;
        margin-bottom: 0.5rem;
      }

      .when-matters ul {
        margin: 0 !important;
      }

      .warm-note {
        background: rgba(166, 227, 161, 0.1);
        border-left: 3px solid var(--ctp-green);
        padding: 0.75rem;
        margin-top: 1rem;
        border-radius: 0 8px 8px 0;
        color: var(--ctp-subtext1);
        font-size: 0.9rem;
      }

      .perf-numbers {
        background: var(--ctp-surface1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .perf-numbers h4 {
        color: var(--ctp-lavender);
        margin-bottom: 0.75rem;
      }

      .perf-table {
        font-size: 0.85rem;
      }

      .perf-table th {
        background: var(--ctp-surface2);
      }

      .perf-table .cold-header {
        background: rgba(137, 180, 250, 0.3);
        color: var(--ctp-blue);
        text-align: center;
      }

      .perf-table .warm-header {
        background: rgba(166, 227, 161, 0.3);
        color: var(--ctp-green);
        text-align: center;
      }

      .perf-table .sub-header th {
        font-size: 0.75rem;
        background: var(--ctp-surface1);
      }

      .perf-table td.source-gen {
        color: var(--ctp-green);
      }

      .perf-table td.reflection {
        color: var(--ctp-subtext0);
      }

      .perf-note {
        color: var(--ctp-subtext0);
        font-size: 0.85rem;
        margin-top: 0.75rem;
        font-style: italic;
      }

      .current-benchmark {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 500;
      }

      .current-benchmark.cold {
        background: rgba(137, 180, 250, 0.15);
        border: 1px solid var(--ctp-blue);
        color: var(--ctp-text);
      }

      .current-benchmark.warm {
        background: rgba(166, 227, 161, 0.15);
        border: 1px solid var(--ctp-green);
        color: var(--ctp-text);
      }

      .current-benchmark .indicator {
        font-size: 1.5rem;
      }

      .no-data-note {
        color: var(--ctp-subtext0);
        font-style: italic;
        padding: 1rem;
        background: var(--ctp-surface1);
        border-radius: 8px;
        border-left: 3px solid var(--ctp-overlay1);
      }

      .no-data-note code {
        background: var(--ctp-surface2);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        color: var(--ctp-teal);
      }

      .data-source {
        color: var(--ctp-green);
        font-size: 0.85rem;
        margin-bottom: 1rem;
        padding: 0.5rem 0.75rem;
        background: rgba(166, 227, 161, 0.1);
        border-radius: 6px;
        border-left: 3px solid var(--ctp-green);
      }

      /* Sample payloads section */
      .sample-payloads {
        border-left: 4px solid var(--ctp-teal);
      }

      .sample-intro {
        color: var(--ctp-subtext0);
        margin-bottom: 1rem;
      }

      .payload-samples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }

      .sample-item {
        background: var(--ctp-surface1);
        border-radius: 8px;
        overflow: hidden;
      }

      .sample-header {
        background: var(--ctp-surface2);
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sample-size {
        color: var(--ctp-peach);
        font-weight: 600;
        font-family: 'Cascadia Code', monospace;
      }

      .sample-name {
        color: var(--ctp-subtext0);
        font-size: 0.85rem;
      }

      .sample-code {
        margin: 0;
        padding: 1rem;
        background: var(--ctp-mantle);
        overflow-x: auto;
        font-size: 0.85rem;
      }

      .sample-code code {
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        color: var(--ctp-text);
        white-space: pre;
      }

      .env-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
      }

      .env-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .env-item .label {
        color: var(--ctp-subtext0);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .env-item .value {
        color: var(--ctp-text);
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        font-size: 0.95rem;
      }

      /* Collapsible metrics */
      .metrics-details {
        cursor: pointer;
      }

      .metrics-details summary {
        list-style: none;
        outline: none;
      }

      .metrics-details summary::-webkit-details-marker {
        display: none;
      }

      .metrics-details summary h2 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .metrics-details summary h2::before {
        content: 'â–¶';
        font-size: 0.8rem;
        transition: transform 0.2s;
        color: var(--ctp-overlay1);
      }

      .metrics-details[open] summary h2::before {
        transform: rotate(90deg);
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .metric-item {
        background: var(--ctp-surface1);
        padding: 1rem;
        border-radius: 8px;
        border-left: 3px solid var(--ctp-blue);
      }

      .metric-name {
        display: block;
        color: var(--ctp-sapphire);
        font-weight: 600;
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        margin-bottom: 0.25rem;
      }

      .metric-desc {
        color: var(--ctp-subtext1);
        font-size: 0.9rem;
      }

      /* Result groups */
      .result-group {
        border-left: 4px solid var(--ctp-blue);
      }

      .result-group h2 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .group-desc {
        color: var(--ctp-subtext0);
        font-size: 0.95rem;
        margin-bottom: 1rem;
        font-style: italic;
      }

      .table-container {
        overflow-x: auto;
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        font-size: 0.9rem;
      }

      th, td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--ctp-surface1);
      }

      th {
        background: var(--ctp-surface1);
        color: var(--ctp-lavender);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
      }

      th.numeric, td.numeric {
        text-align: right;
      }

      .description-cell {
        font-family: 'Segoe UI', system-ui, sans-serif;
        color: var(--ctp-text);
        min-width: 300px;
      }

      tr:hover {
        background: var(--ctp-surface1);
      }

      .baseline-row {
        background: rgba(166, 227, 161, 0.1);
      }

      .baseline-row:hover {
        background: rgba(166, 227, 161, 0.15);
      }

      .rank-first {
        color: var(--ctp-green);
        font-weight: bold;
      }

      .rank-second {
        color: var(--ctp-yellow);
      }

      .rank-third {
        color: var(--ctp-peach);
      }

      .ratio-excellent {
        color: var(--ctp-green);
      }

      .ratio-good {
        color: var(--ctp-teal);
      }

      .ratio-baseline {
        color: var(--ctp-text);
        font-weight: bold;
      }

      .ratio-slower {
        color: var(--ctp-yellow);
      }

      .ratio-much-slower {
        color: var(--ctp-red);
      }

      .legend {
        background: var(--ctp-mantle);
      }

      .units-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
      }

      .unit {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
      }

      .unit-name {
        color: var(--ctp-peach);
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        font-weight: bold;
        min-width: 2rem;
      }

      .unit-desc {
        color: var(--ctp-subtext0);
        font-size: 0.9rem;
      }

      /* Takeaways */
      .takeaways {
        background: linear-gradient(135deg, var(--ctp-surface0), rgba(249, 226, 175, 0.05));
        border-left: 4px solid var(--ctp-yellow);
      }

      .insights-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .insights-list li {
        padding-left: 1.5rem;
        position: relative;
        color: var(--ctp-subtext1);
      }

      .insights-list li::before {
        content: 'â†’';
        position: absolute;
        left: 0;
        color: var(--ctp-yellow);
      }

      .insights-list li strong {
        color: var(--ctp-text);
      }

      /* Runtime comparison section */
      .runtime-comparison {
        background: linear-gradient(135deg, var(--ctp-surface0), rgba(116, 199, 236, 0.05));
        border-left: 4px solid var(--ctp-sapphire);
      }

      .runtime-note {
        background: var(--ctp-mantle);
        border-left: 4px solid var(--ctp-overlay1);
      }

      .runtime-note .command-example {
        background: var(--ctp-surface0);
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin: 0.5rem 0;
        overflow-x: auto;
      }

      .runtime-note .command-example code {
        font-family: 'Cascadia Code', 'Fira Code', monospace;
        color: var(--ctp-teal);
        font-size: 0.9rem;
      }

      .runtime-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        font-family: 'Cascadia Code', monospace;
      }

      .runtime-badge.net9 {
        background: rgba(137, 180, 250, 0.2);
        color: var(--ctp-blue);
        border: 1px solid var(--ctp-blue);
      }

      .runtime-badge.net10 {
        background: rgba(166, 227, 161, 0.2);
        color: var(--ctp-green);
        border: 1px solid var(--ctp-green);
      }

      .net9-row {
        background: rgba(137, 180, 250, 0.05);
      }

      .net9-row:hover {
        background: rgba(137, 180, 250, 0.1);
      }

      .net10-row {
        background: rgba(166, 227, 161, 0.05);
      }

      .net10-row:hover {
        background: rgba(166, 227, 161, 0.1);
      }

      .faster {
        color: var(--ctp-green);
        font-weight: 600;
      }

      .slower {
        color: var(--ctp-red);
        font-weight: 600;
      }

      .same {
        color: var(--ctp-subtext0);
      }

      .runtime-summary {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--ctp-surface1);
      }

      .runtime-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--ctp-text);
        font-family: 'Cascadia Code', monospace;
      }

      .stat-value.faster {
        color: var(--ctp-green);
      }

      .stat-value.slower {
        color: var(--ctp-red);
      }

      .stat-label {
        color: var(--ctp-subtext0);
        font-size: 0.85rem;
        text-align: center;
      }

      footer {
        text-align: center;
        padding: 2rem;
        color: var(--ctp-overlay1);
        font-size: 0.85rem;
        border-top: 1px solid var(--ctp-surface0);
        margin-top: 2rem;
      }

      footer p {
        margin: 0.25rem 0;
      }

      @media (max-width: 768px) {
        main {
          padding: 1rem;
        }

        header h1 {
          font-size: 1.5rem;
        }

        th, td {
          padding: 0.5rem;
          font-size: 0.8rem;
        }

        .description-cell {
          min-width: 200px;
        }
      }
    </style>
    """;
}
