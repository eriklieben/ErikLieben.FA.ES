using Azure.Storage.Blobs;
using ErikLieben.FA.ES;
using ErikLieben.FA.ES.AzureStorage.Blob;
using ErikLieben.FA.ES.Documents;
using ErikLieben.FA.ES.Projections;
using ErikLieben.FA.ES.VersionTokenParts;
using Microsoft.Extensions.Azure;
using System;
using System.CodeDom.Compiler;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.IO;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading;
using System.Threading.Tasks;
using TaskFlow.Domain.Events.UserProfile;

namespace TaskFlow.Domain.Projections;

// <auto-generated />
[GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
[ExcludeFromCodeCoverage]
public partial class UserProfiles : IUserProfiles
{

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    public UserProfiles() : base()
    {
    }

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    public UserProfiles(IObjectDocumentFactory documentFactory, IEventStreamFactory eventStreamFactory)
      : base(documentFactory, eventStreamFactory)
    {
    }

#nullable enable
    /// <summary>
    /// Dispatches events to When methods. Called by base RoutedProjection.Fold after routing context setup.
    /// </summary>
    protected override void DispatchToWhen(IEvent @event, VersionToken versionToken)
    {
        switch (@event.EventType)
        {
            case "UserProfile.Created":
                When(JsonEvent.ToEvent(@event, UserProfileCreatedJsonSerializerContext.Default.UserProfileCreated).Data(), GetWhenParameterValue<String, UserProfileCreated>(
                         "String",
                         versionToken, @event)!);
                break;
            case "UserProfile.Updated":
                When(JsonEvent.ToEvent(@event, UserProfileUpdatedJsonSerializerContext.Default.UserProfileUpdated).Data(), GetWhenParameterValue<String, UserProfileUpdated>(
                         "String",
                         versionToken, @event)!);
                break;
        }
    }

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    protected override Task PostWhenAll(IObjectDocument document) { return Task.CompletedTask; }
#nullable restore

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    protected override Dictionary<string, IProjectionWhenParameterValueFactory> WhenParameterValueFactories { get; } =
          new Dictionary<string, IProjectionWhenParameterValueFactory>(){
              {"String", new TaskFlow.Domain.Projections.ObjectIdWhenValueFactory()}
          };

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    public static UserProfiles? LoadFromJson(string json, IObjectDocumentFactory documentFactory, IEventStreamFactory eventStreamFactory)
    {
        // Deserialize each property manually to preserve data
        System.Int32? totalPages = null;
        System.Int32? totalUsers = null;
        System.Collections.Generic.IReadOnlyDictionary<System.String, ErikLieben.FA.ES.Projections.Projection>? destinations = null;
        ErikLieben.FA.ES.Projections.RoutedProjectionMetadata? routingMetadata = null;
        ErikLieben.FA.ES.Projections.DestinationRegistry? registry = null;
        System.String? pathTemplate = null;
        System.Object? metadata = null;
        ErikLieben.FA.ES.Documents.IObjectDocument? currentDocument = null;
        System.String? checkpointFingerprint = null;
        Checkpoint checkpoint = [];

        var reader = new Utf8JsonReader(System.Text.Encoding.UTF8.GetBytes(json));

        if (!reader.Read() || reader.TokenType != JsonTokenType.StartObject)
            return null;

        while (reader.Read())
        {
            if (reader.TokenType == JsonTokenType.EndObject)
                break;

            if (reader.TokenType != JsonTokenType.PropertyName)
                continue;

            string? propertyName = reader.GetString();
            reader.Read();

            switch (propertyName)
            {
                case "TotalPages":
                    totalPages = JsonSerializer.Deserialize<System.Int32>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "TotalUsers":
                    totalUsers = JsonSerializer.Deserialize<System.Int32>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "$checkpoint":
                    checkpoint = JsonSerializer.Deserialize<ErikLieben.FA.ES.Checkpoint>(ref reader, UserProfilesJsonSerializerContext.Default.Options) ?? [];
                    break;
                case "Destinations":
                    destinations = JsonSerializer.Deserialize<System.Collections.Generic.IReadOnlyDictionary<System.String, ErikLieben.FA.ES.Projections.Projection>>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "RoutingMetadata":
                    routingMetadata = JsonSerializer.Deserialize<ErikLieben.FA.ES.Projections.RoutedProjectionMetadata>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "Registry":
                    registry = JsonSerializer.Deserialize<ErikLieben.FA.ES.Projections.DestinationRegistry>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "PathTemplate":
                    pathTemplate = JsonSerializer.Deserialize<System.String>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "Metadata":
                    metadata = JsonSerializer.Deserialize<System.Object>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "CurrentDocument":
                    currentDocument = JsonSerializer.Deserialize<ErikLieben.FA.ES.Documents.IObjectDocument>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
                case "$checkpointFingerprint":
                    checkpointFingerprint = JsonSerializer.Deserialize<System.String>(ref reader, UserProfilesJsonSerializerContext.Default.Options);
                    break;
            }
        }

        // Create instance with factories and deserialized properties
        var instance = new UserProfiles(documentFactory, eventStreamFactory);

        instance.Checkpoint = checkpoint;
        instance.CheckpointFingerprint = checkpointFingerprint;

        return instance;
    }

    [GeneratedCode("ErikLieben.FA.ES", "1.0.0.0")]
    [ExcludeFromCodeCoverage]
    public override string ToJson()
    {
        return JsonSerializer.Serialize(this, UserProfilesJsonSerializerContext.Default.UserProfiles);
    }

    /// <summary>
    /// Gets or sets the checkpoint tracking the last processed event position.
    /// </summary>
    [JsonIgnore]
    public override Checkpoint Checkpoint { get; set; } = [];

    /// <summary>
    /// Creates a destination instance with proper initialization.
    /// AOT-compatible implementation without reflection.
    /// </summary>
    protected override TDestination CreateDestinationInstance<TDestination>(string destinationKey)
    {
        if (typeof(TDestination) == typeof(UserProfilePage))
        {
            var destination = new UserProfilePage(DocumentFactory!, EventStreamFactory!);
            return (TDestination)(Projection)destination;
        }
        else if (typeof(TDestination) == typeof(TeamMembers))
        {
            var destination = new TeamMembers(DocumentFactory!, EventStreamFactory!);
            return (TDestination)(Projection)destination;
        }

        throw new ArgumentException($"Unknown destination type: {typeof(TDestination).Name}", nameof(TDestination));
    }
}

/// <summary>
/// Factory for creating and managing UserProfiles routed blob-based projections.
/// Main file at [BlobJsonProjection] path contains $checkpoint and $metadata.
/// Each destination is stored in a separate file.
/// </summary>
public partial class UserProfilesFactory(
    IAzureClientFactory<BlobServiceClient> blobServiceClientFactory,
    IObjectDocumentFactory objectDocumentFactory,
    IEventStreamFactory eventStreamFactory)
    : RoutedBlobProjectionFactory<UserProfiles>(
        blobServiceClientFactory,
        "BlobStorage",
        "projections/userprofiles.json")
{
    /// <summary>
    /// Gets the JSON serializer context for the projection.
    /// </summary>
    protected override JsonSerializerContext GetProjectionJsonContext()
    {
        return UserProfilesJsonSerializerContext.Default;
    }

    /// <summary>
    /// Loads the main projection (checkpoint and metadata) from JSON.
    /// </summary>
    protected override UserProfiles? LoadMainProjectionFromJson(
        string json,
        IObjectDocumentFactory documentFactory,
        IEventStreamFactory eventStreamFactory)
    {
        return UserProfiles.LoadFromJson(json, documentFactory, eventStreamFactory);
    }

    /// <summary>
    /// Loads a destination projection from JSON.
    /// </summary>
    protected override Projection LoadDestinationFromJson(
        string json,
        IObjectDocumentFactory documentFactory,
        IEventStreamFactory eventStreamFactory,
        string destinationKey)
    {
        // Multiple destination types - try to deserialize based on registry
        Projection? result;
        result = UserProfilePage.LoadFromJson(json, documentFactory, eventStreamFactory);
        if (result != null) return result;
        result = TeamMembers.LoadFromJson(json, documentFactory, eventStreamFactory);
        if (result != null) return result;
        throw new ArgumentException($"Failed to deserialize destination {destinationKey}", nameof(destinationKey));
    }

    /// <summary>
    /// Checks if a destination type has external checkpoint enabled.
    /// </summary>
    protected override bool DestinationHasExternalCheckpoint(string destinationTypeName)
    {
        return destinationTypeName switch
        {
            "TeamMembers" => true,
            _ => false
        };
    }

    /// <summary>
    /// Serializes the main projection (checkpoint and metadata) to JSON.
    /// </summary>
    protected override string SerializeMainProjection(UserProfiles projection)
    {
        return projection.ToJson();
    }

    /// <summary>
    /// Gets save tasks for all destinations.
    /// </summary>
    protected override IEnumerable<Task> GetDestinationSaveTasks(
        UserProfiles projection,
        BlobContainerClient containerClient,
        CancellationToken cancellationToken)
    {
        if (projection.Destinations == null)
        {
            yield break;
        }

        foreach (var kvp in projection.Destinations)
        {
            var destinationKey = kvp.Key;
            var destination = kvp.Value;

            // Get the blob path from registry
            if (projection.Registry.Destinations.TryGetValue(destinationKey, out var metadata) &&
                metadata.Metadata.TryGetValue("blobPath", out var blobPath))
            {
                var json = destination.ToJson();
                yield return UploadBlobAsync(containerClient, blobPath, json, cancellationToken);

                // Save external checkpoint if the destination type has it enabled
                if (DestinationHasExternalCheckpoint(metadata.DestinationTypeName))
                {
                    yield return SaveDestinationCheckpointAsync(blobPath, destination, cancellationToken);
                }
            }
        }
    }

    /// <summary>
    /// Adds a loaded destination to the projection.
    /// </summary>
    protected override void AddDestinationToProjection(
        UserProfiles projection,
        string destinationKey,
        Projection destination)
    {
        // Use reflection to access the private _destinations field in RoutedProjection
        var destinationsField = typeof(RoutedProjection).GetField("_destinations", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var destinations = destinationsField?.GetValue(projection) as System.Collections.Concurrent.ConcurrentDictionary<string, Projection>;

        if (destinations != null)
        {
            destinations[destinationKey] = destination;
        }
    }

    /// <summary>
    /// Sets the factories on the projection.
    /// </summary>
    protected override void SetFactories(
        UserProfiles projection,
        IObjectDocumentFactory documentFactory,
        IEventStreamFactory eventStreamFactory)
    {
        // Use reflection to set the private readonly fields
        var docField = typeof(Projection).GetField("DocumentFactory", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        var streamField = typeof(Projection).GetField("EventStreamFactory", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);

        docField?.SetValue(projection, documentFactory);
        streamField?.SetValue(projection, eventStreamFactory);
    }

    /// <summary>
    /// Gets the path template for a destination type from its [BlobJsonProjection] attribute.
    /// </summary>
    protected override string? GetDestinationPathTemplate(string destinationTypeName)
    {
        return destinationTypeName switch
        {
            "UserProfilePage" => "projections/userprofiles/page-{pageNumber}.json",
            "TeamMembers" => "projections/userprofiles/team-members.json",
            _ => null
        };
    }
}

/// <summary>
/// JSON serializer context for DestinationRegistry and related types.
/// </summary>
[JsonSerializable(typeof(DestinationRegistry))]
[JsonSerializable(typeof(DestinationMetadata))]
[JsonSerializable(typeof(RoutedProjectionMetadata))]
[JsonSerializable(typeof(UserProfilePage))]
[JsonSourceGenerationOptions(WriteIndented = true)]
internal partial class UserProfilesDestinationRegistryJsonContext : JsonSerializerContext
{
}

#nullable enable
// <auto-generated />
/// <summary>
/// Interface defining the public state properties of UserProfiles.
/// </summary>
public interface IUserProfiles
{
    public Int32 TotalPages { get; }
    public Int32 TotalUsers { get; }
    public IReadOnlyDictionary<System.String, ErikLieben.FA.ES.Projections.Projection>? Destinations { get; }
    public RoutedProjectionMetadata? RoutingMetadata { get; }
    public DestinationRegistry? Registry { get; }
    public String? PathTemplate { get; }
    public Object? Metadata { get; }
    public IObjectDocument? CurrentDocument { get; }
    public String? CheckpointFingerprint { get; }
}
#nullable restore

[JsonSerializable(typeof(UserProfileCreated))]
[JsonSerializable(typeof(UserProfileUpdated))]
[JsonSerializable(typeof(System.Int32))]
[JsonSerializable(typeof(System.Collections.Generic.Dictionary<System.String, ErikLieben.FA.ES.Projections.IProjectionWhenParameterValueFactory>))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Projections.IProjectionWhenParameterValueFactory))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Checkpoint))]
[JsonSerializable(typeof(System.Collections.Generic.IReadOnlyDictionary<System.String, ErikLieben.FA.ES.Projections.Projection>))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Projections.Projection))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Projections.RoutedProjectionMetadata))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Projections.DestinationRegistry))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Projections.DestinationMetadata))]
[JsonSerializable(typeof(System.DateTimeOffset))]
[JsonSerializable(typeof(System.DayOfWeek))]
[JsonSerializable(typeof(System.Enum))]
[JsonSerializable(typeof(System.TimeSpan))]
[JsonSerializable(typeof(System.Double))]
[JsonSerializable(typeof(System.Object))]
[JsonSerializable(typeof(ErikLieben.FA.ES.Documents.IObjectDocument))]
[JsonSerializable(typeof(UserProfiles))]
// <auto-generated />
/// <summary>
/// JSON serializer context for UserProfiles types.
/// </summary>
internal partial class UserProfilesJsonSerializerContext : JsonSerializerContext
{
}

